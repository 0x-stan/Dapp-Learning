## TWAMM介绍

TWAMM（Time-Weighted Average Market Maker）源于paradiam的论文： https://www.paradigm.xyz/2021/07/twamm. 是一种新兴的去中心化交易机制，旨在解决传统市场中流动性不足和价格波动带来的问题。TWAMM主要应用于去中心化金融（DeFi）领域，作为一种创新的做市策略，能够在保持市场公平性的同时，提供更好的流动性和价格发现机制。

1. 背景与发展
随着区块链技术的迅速发展，去中心化交易所（DEX）逐渐成为加密货币交易的重要场所。尽管DEX提供了更高的透明度和用户控制权，但它们也面临流动性不足和价格波动大的挑战。这些问题使得用户在交易时常常面临较高的滑点和不理想的交易体验。TWAMM的出现正是为了应对这些挑战，通过创新的算法和机制来优化交易过程。

2. TWAMM的工作原理
TWAMM的核心在于“时间加权”的概念。传统的做市机制往往是基于当前市场价格进行交易，这意味着大额交易会对市场价格产生显著影响。而TWAMM通过分批执行交易，将大额订单拆分为多个小额订单，在预定的时间内逐步完成交易，从而降低对市场价格的冲击。

具体而言，TWAMM会根据用户的订单类型和市场状态，计算出一个最佳的时间窗口，在这个窗口内逐步执行订单。通过这种方式，TWAMM能够有效地抑制价格波动，使得市场价格更加稳定。此外，TWAMM还可以利用时间加权的方式，对订单进行定价，确保交易的公平性。

3. TWAMM的优势
TWAMM的设计带来了多个显著优势：

流动性提升：通过将大额订单分解为多个小额订单，TWAMM能够在更长的时间内提供流动性，吸引更多的交易者参与市场。
降低滑点：由于交易是分批进行的，TWAMM显著降低了大额交易的滑点风险，使得用户能够以更接近预期价格的水平完成交易。
价格稳定性：TWAMM的时间加权机制使得市场价格波动更小，有助于维护价格的稳定性，提升用户的交易信心。
公平性：TWAMM的设计考虑了不同交易者的需求，通过合理的定价机制，确保所有参与者在交易中都能获得公平的待遇。
4. TWAMM的应用场景
TWAMM的应用场景非常广泛，尤其是在需要高流动性和价格稳定性的市场中。以下是一些具体的应用例子：

大宗商品交易：在大宗商品市场中，TWAMM可以帮助交易者在不影响市场价格的情况下完成大额交易。
去中心化交易所：作为DEX的一种创新机制，TWAMM能够提高其流动性和用户体验，吸引更多的交易者参与。
流动性挖掘：TWAMM的机制可以与流动性挖掘相结合，鼓励用户提供流动性，从而进一步提升市场的活跃度。
5. 未来展望
TWAMM作为一种新兴的交易机制，展现出了极大的潜力。随着DeFi生态系统的不断发展，引入更多的创新机制将是必然趋势。TWAMM不仅能够优化交易体验，还可能推动去中心化金融的进一步普及与发展。

总之，TWAMM通过其独特的时间加权策略，解决了传统市场中流动性和价格波动的问题，为去中心化金融的未来发展提供了有力的支持。随着技术的不断进步和市场的不断成熟，TWAMM有望在更广泛的金融场景中发挥重要作用。


## 操作流程

### **1. 提交长期订单**
用户或交易者向TWAMM提交长期订单，需设定两个关键参数：
- **订单规模**：需要交易的资产总量（例如，卖出100 ETH或买入1亿USDC）。
- **执行期限**：订单执行的持续时间（例如，2000个区块，约数小时或数天）。
  提交后，订单将被存储于TWAMM的智能合约中，并通过时间加权算法进行拆分。

---

### **2. 订单分解为无限小虚拟订单**
TWAMM通过数学算法将长期订单分解为**无限多个无限小的虚拟订单**，这些订单按时间均匀分布在整个执行期限内。例如，一个持续2000区块的订单，每个区块会被分解为极小的交易量，确保执行过程平滑且对市场价格影响最小。

---

### **3. 逐区块执行虚拟订单**
在每个新区块生成时，TWAMM自动执行当前区块对应的虚拟订单：
- **执行顺序优先**：TWAMM订单在每个区块中**优先于普通交易执行**，避免被夹心攻击（Sandwich Attack）等MEV（矿工可提取价值）策略干扰。
- **嵌入式AMM交互**：虚拟订单与TWAMM内置的恒定乘积AMM（如Uniswap V4的流动性池）交互，根据当前池的储备计算交易价格。

---

### **4. 套利平衡价格**
由于TWAMM的持续执行会改变嵌入式AMM的资产价格，套利者会通过以下机制维持价格与外部市场一致：
- **价格偏差触发套利**：当嵌入式AMM价格偏离其他交易所（如中心化交易所）时，套利者会买入低价资产并卖出高价资产，推动价格回归平衡。
- **确保执行价格接近时间加权平均价（TWAP）**：套利行为使得TWAMM的最终成交价趋近于执行期间的市场平均价格，减少滑点。

---

### **5. 订单完成与结算**
- **到期自动终止**：订单在执行期限结束时自动终止，未完成的剩余部分（如有）将按最终价格结算。
- **Gas成本优化**：TWAMM采用**延迟计算（Lazy Evaluation）**技术，仅在需要时结算虚拟订单的累积影响，避免高频交易的高Gas成本。

---

### **技术实现的关键点**
- **数学公式支持**：通过积分等数学方法计算虚拟订单的累积交易量，避免逐个处理无限小订单的计算开销。
- **防攻击设计**：通过优先执行和区块间交易，减少三明治攻击风险；同时限制订单修改权限，防止信息泄露。


## 操作步骤
以下是使用TWAMM进行交易的具体操作步骤：

1 准备工作

选择合适的去中心化交易平台：用户需要选择一个支持TWAMM协议的去中心化交易平台，例如Uniswap V3等。确保该平台有足够的流动性和用户基础，以便顺利执行交易。
创建数字钱包：用户需要一个支持ERC-20代币的数字钱包，如MetaMask或Trust Wallet，来存储和管理其加密资产。

连接钱包：访问所选择的去中心化交易平台，并将数字钱包连接到该平台。通常，这需要用户授权平台访问其钱包地址。


2 设置交易参数

选择交易对：在TWAMM交易界面，用户需要选择想要交易的代币对。例如，如果用户想要交易ETH与DAI，则需要选择这两个代币。

输入交易数量：用户需要输入希望交易的代币数量。TWAMM会根据用户输入的数量和时间段来计算每个时间段内的交易量。

设定时间段：用户可以选择交易的时间段。例如，用户可以选择在1小时、6小时、12小时或24小时内执行交易。时间段的选择会影响平均价格的计算，用户需要根据自己的需求进行合理选择。

确认交易参数：在设置完所有参数后，用户需要仔细确认交易信息，包括交易对、数量、时间段等，以确保没有错误。


3.3 执行交易

提交交易请求：确认无误后，用户可以提交交易请求。TWAMM系统会将用户的交易请求记录在区块链上，并准备在设定的时间段内执行。

分段执行交易：在设定的时间段内，TWAMM会按照预设的时间间隔自动执行交易。每个时间段内的交易量和价格会根据市场情况进行调整，以确保交易的顺利进行。

监控交易状态：用户可以在交易平台上监控交易的执行状态。TWAMM会提供实时的交易执行情况，包括已完成的交易和剩余的交易量。


3.4 交易完成
查看交易结果：一旦所有交易完成，用户可以查看最终的交易结果，包括实际成交的价格、交易的总费用和所获得的代币数量。

提取资产：用户可以选择将交易获得的代币提取到自己的数字钱包中，或者继续在平台上进行其他交易。
分析交易表现：用户可以对交易进行回顾分析，比如比较实际成交价格与市场价格的差异，评估TWAMM在交易中带来的优势。


目前市面上有两个项目方实现： FRAX & Pulsar

Frax技术方案： https://docs.frax.finance/fraxswap/technical-specifications 
合约地址：https://docs.frax.finance/smart-contracts/fraxswap

pular技术方案： https://pulsarswap.com/  
数学推导：https://hackmd.io/@luffy/SJxSsOH1Y?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2NTg0NTk0MDQsImZpbGVHVUlEIjoiR2VYSGc0TVJzU3c1SFFVbyIsImlhdCI6MTY1ODQ1OTEwNCwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotNjgyMDA2MTkyMH0.Dmo2Lu-fva3LKJoyO8nACJ20cDJ8PpOGP2D6WzC5klA 
 
v3: https://hackmd.io/@luffy/rJf4OUeWq?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2NTg0NTk0NzMsImZpbGVHVUlEIjoiR2VYSGc0TVJzU3c1SFFVbyIsImlhdCI6MTY1ODQ1OTE3MywiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotNjgyMDA2MTkyMH0.K140eySZKKzx9CUzJzS2TtyZh4GVsf0_C4hpUtQ9u_w  

## 参考文档

- github实现： https://github.com/FrankieIsLost/TWAMM/tree/master/contracts

-https://www.paradigm.xyz/2021/07/twamm

-https://zhuanlan.zhihu.com/p/394675989